<!doctype html>
<html>
<head>
  <style>
  .bit-card{
    margin-top: 16px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    background: rgba(255,255,255,.03);
  }
  .bit-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:10px 0; }
  .bit-row label{ color: var(--muted); font-size: 14px; }
  .bit-row input{
    width: 110px;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.15);
    color: var(--text);
    outline: none;
  }
  .bit-row button{
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--text);
    cursor: pointer;
  }
  .bit-row button:hover{ background: rgba(255,255,255,.10); }
  .bit-note{ color: var(--muted); font-size: 14px; line-height: 1.5; }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  .table-like{
    overflow-x:auto;
    padding-bottom: 6px;
  }

  .cells{ display:flex; gap:8px; align-items:flex-end; flex-wrap:nowrap; }
  .cell{
    min-width: 78px;
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.03);
    position: relative;
  }
  .cell .top{ font-size: 12px; color: var(--muted); }
  .cell .val{ font-size: 16px; margin-top: 6px; }
  .cell .range{ font-size: 11px; color: var(--muted); margin-top: 6px; }

  .cell.active{
    border-color: rgba(122,162,255,.60);
    box-shadow: 0 0 0 3px rgba(122,162,255,.18);
    background: rgba(122,162,255,.10);
  }

  .out{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
    color: var(--text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    white-space: pre-wrap;
  }
</style>

  <meta charset="utf-8">
  <title>樹狀陣列</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="wrap">

    <div class="post-topbar">
      <a class="back-link" href="../index.html">← back</a>

      <button class="theme-btn" id="themeBtn" type="button">
        <span class="theme-txt">Dark</span>
      </button>
    </div>

    <h1>樹狀陣列</h1>
    <p>
樹狀陣列（Fenwick Tree / BIT）是一種用 <b>O(N)</b> 空間維護前綴資訊的資料結構，
專門用來處理「<b>單點修改</b>」與「<b>前綴和 / 區間和查詢</b>」。
</p>

<p>
BIT 之所以能運作 是因為它維護的資訊必須滿足 <b>結合律</b>（例如加法）
並且能透過前綴差分得到區間答案：
<b>sum(l..r) = prefix(r) - prefix(l-1)</b>。
因此最常見用途是維護「和」也可擴展到 XOR 等可用前綴差分的運算
</p>


<p>
樹狀陣列支援：
<ul>
  <li><b>單點修改：</b> a[x] += v 時間 <b>O(log N)</b></li>
  <li><b>前綴和：</b> sum(1..x) 時間 <b>O(log N)</b></li>
  <li><b>區間和：</b> sum(l..r) = prefix(r) - prefix(l-1) 時間 <b>O(log N)</b></li>
</ul>
</p>

<p>
其中關鍵函式是 <b>lowbit(x)</b>：
<b>lowbit(x) = x & (-x)</b> 
代表 x 的二進位中「最右邊的 1」所對應的值（2 的冪次） 
例如：
<ul>
  <li>lowbit(8 = 1000) = 8</li>
  <li>lowbit(7 = 0111) = 1</li>
  <li>lowbit(6 = 0110) = 2</li>
</ul>
</p>

<p>
BIT 的節點意義是：<b>bit[i]</b> 管理一段連續區間的總和：
<b>[ i - lowbit(i) + 1 , i ]</b> 
也就是「以 i 為右端點、長度為 lowbit(i) 的區間」 
</p>

<p>
例如：
<ul>
  <li><b>bit[8]</b>：lowbit(8)=8 → 管 <b>[1, 8]</b></li>
  <li><b>bit[7]</b>：lowbit(7)=1 → 管 <b>[7, 7]</b></li>
  <li><b>bit[6]</b>：lowbit(6)=2 → 管 <b>[5, 6]</b></li>
</ul>
</p>

<p>
為什麼查詢和更新都是 O(logN)？
<ul>
  <li><b>查詢 prefix(x)：</b> 從 x 開始 把 bit[x] 加進答案後 令 x -= lowbit(x) 不斷往前跳直到 0</li>
  <li><b>更新 add(x, v)：</b> 從 x 開始 令 bit[x] += v 然後 x += lowbit(x) 跳到下一個「包含 x 的更大區間」 直到超過 N</li>
</ul>
因此：
<ul>
  <li><b>x + lowbit(x)</b> 可以視為「往上跳到父節點」</li>
  <li><b>x - lowbit(x)</b> 可以視為「往前跳到剩下前綴」</li>
</ul>
</p>

<br>
    <p>實作程式碼：</p>
    
<pre><code class="language-cpp">int lowbit(int x){
    rtn x&amp;-x;
}
  
void change(int x,int k){
    while(x&lt;=n)a[x]+=k,x+=lowbit(x);
}
  
int query(int x){
    int t=0;
    while(x)t+=a[x],x-=lowbit(x);
    rtn t;
}</code></pre>
<br>

<div class="bit-card" id="bitViz">
  <h2 style="margin:0 0 8px 0;">Fenwick Tree 視覺化</h2>
  <div class="bit-note">
    Fenwick 的核心：<b>bit[i]</b> 管的是區間 <b>[i - lowbit(i) + 1 .. i]</b>。<br>
    Update: i += lowbit(i)； Query: i -= lowbit(i)。
  </div>

  <div class="bit-row">
    <label>N</label>
    <input id="nInput" type="number" min="1" max="32" value="8">
    <label>初始化 a[1..N]（用空白分隔）</label>
    <input id="arrInput" type="text" value="3 1 4 1 5 9 2 6" style="width:340px;">
    <button id="buildBtn" type="button">Build</button>
  </div>

  <div class="bit-row">
    <label>Update: add at index</label>
    <input id="updIdx" type="number" min="1" value="3">
    <label>delta</label>
    <input id="updDelta" type="number" value="5">
    <button id="updBtn" type="button">Apply Update</button>

    <span style="width:18px;"></span>

    <label>Query: prefix sum up to</label>
    <input id="qryIdx" type="number" min="1" value="6">
    <button id="qryBtn" type="button">Run Query</button>
    <button id="clearHiBtn" type="button">Clear Highlight</button>
  </div>

  <div class="grid">
    <div class="table-like">
      <div style="color:var(--muted); font-size:13px; margin-bottom:6px;">a[i]（原陣列）</div>
      <div class="cells" id="aCells"></div>
    </div>

    <div class="table-like">
      <div style="color:var(--muted); font-size:13px; margin-bottom:6px;">bit[i]（Fenwick 內部樹狀值）</div>
      <div class="cells" id="bitCells"></div>
    </div>

    <div class="out" id="logBox">Click “Build” to initialize.</div>
  </div>
</div>

    
    <p></p>
    <p></p>
    <p></p>
    <p></p>
  </div>
<script>
(function(){
  let N = 8;
  let a = [];
  let bit = [];

  const el = (id) => document.getElementById(id);

  function lowbit(x){ return x & -x; }

  function resetArrays(n){
    N = n;
    a = new Array(N+1).fill(0);
    bit = new Array(N+1).fill(0);
  }

  function bitAdd(i, delta){
    while(i <= N){
      bit[i] += delta;
      i += lowbit(i);
    }
  }

  function bitSum(i){
    let s = 0;
    while(i > 0){
      s += bit[i];
      i -= lowbit(i);
    }
    return s;
  }

  function buildFromA(){
    bit.fill(0);
    for(let i=1;i<=N;i++) bitAdd(i, a[i]);
  }

  function rangeOf(i){
    const l = i - lowbit(i) + 1;
    const r = i;
    return [l, r];
  }

  function clearHighlights(){
    for(const node of document.querySelectorAll("#bitCells .cell")){
      node.classList.remove("active");
    }
  }

  function render(){
    // a cells
    const aWrap = el("aCells");
    aWrap.innerHTML = "";
    for(let i=1;i<=N;i++){
      const div = document.createElement("div");
      div.className = "cell";
      div.innerHTML = `
        <div class="top">a[${i}]</div>
        <div class="val">${a[i]}</div>
      `;
      aWrap.appendChild(div);
    }

    // bit cells + ranges
    const bWrap = el("bitCells");
    bWrap.innerHTML = "";
    for(let i=1;i<=N;i++){
      const [l,r] = rangeOf(i);
      const div = document.createElement("div");
      div.className = "cell";
      div.dataset.idx = String(i);
      div.innerHTML = `
        <div class="top">bit[${i}]</div>
        <div class="val">${bit[i]}</div>
        <div class="range">covers [${l}..${r}]</div>
      `;
      bWrap.appendChild(div);
    }
  }

  function highlightIndices(list){
    clearHighlights();
    const set = new Set(list);
    for(const node of document.querySelectorAll("#bitCells .cell")){
      const idx = Number(node.dataset.idx);
      if(set.has(idx)) node.classList.add("active");
    }
  }

  function log(msg){
    el("logBox").textContent = msg;
  }

  function parseArray(input, n){
    const parts = input.trim().split(/\s+/).filter(x => x.length);
    const res = new Array(n+1).fill(0);
    for(let i=1;i<=n;i++){
      res[i] = (i-1 < parts.length) ? Number(parts[i-1]) : 0;
      if(!Number.isFinite(res[i])) res[i] = 0;
    }
    return res;
  }

  // UI handlers
  el("buildBtn").addEventListener("click", function(){
    const n = Math.max(1, Math.min(32, Number(el("nInput").value || 8)));
    resetArrays(n);
    a = parseArray(el("arrInput").value, N);
    buildFromA();
    render();
    clearHighlights();
    log(
`Built Fenwick with N=${N}
Rule: bit[i] covers [i-lowbit(i)+1 .. i]
Try: Update index + delta, or Query prefix sum.`
    );
  });

  el("updBtn").addEventListener("click", function(){
    const idx = Number(el("updIdx").value);
    const delta = Number(el("updDelta").value);
    if(!(1 <= idx && idx <= N) || !Number.isFinite(delta)){
      log("Invalid update input.");
      return;
    }
    a[idx] += delta;

    // compute update path for highlight
    let path = [];
    let i = idx;
    while(i <= N){
      path.push(i);
      i += lowbit(i);
    }

    bitAdd(idx, delta);
    render();
    highlightIndices(path);

    log(
`Update: a[${idx}] += ${delta}
Touched indices (i += lowbit(i)): ${path.join(" -> ")}
Now prefixSum(${idx}) = ${bitSum(idx)}`
    );
  });

  el("qryBtn").addEventListener("click", function(){
    const idx = Number(el("qryIdx").value);
    if(!(1 <= idx && idx <= N)){
      log("Invalid query index.");
      return;
    }

    // compute query path for highlight
    let path = [];
    let i = idx;
    let s = 0;
    while(i > 0){
      path.push(i);
      s += bit[i];
      i -= lowbit(i);
    }

    highlightIndices(path);
    log(
`Query: prefixSum(${idx})
Visited indices (i -= lowbit(i)): ${path.join(" -> ")}
Answer = ${s}`
    );
  });

  el("clearHiBtn").addEventListener("click", function(){
    clearHighlights();
    log("Highlights cleared.");
  });

  // auto-build once
  el("buildBtn").click();
})();
</script>

  <script src="../script.js"></script>
</body>
</html>
